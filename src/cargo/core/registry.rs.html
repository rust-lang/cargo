<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <meta name="description" content="Source to the Rust file `src/cargo/core/registry.rs`.">
    <meta name="keywords" content="rust, rustlang, rust-lang">

    <title>registry.rs.html -- source</title>

    <link rel="stylesheet" type="text/css" href="../../../normalize.css">
    <link rel="stylesheet" type="text/css" href="../../../rustdoc.css">
    <link rel="stylesheet" type="text/css" href="../../../main.css">
    

    
    
</head>
<body class="rustdoc source">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    

    <nav class="sidebar">
        <div class="sidebar-menu">&#9776;</div>
        
        
    </nav>

    <nav class="sub">
        <form class="search-form js-only">
            <div class="search-container">
                <input class="search-input" name="search"
                       autocomplete="off"
                       placeholder="Click or press ‘S’ to search, ‘?’ for more options…"
                       type="search">
            </div>
        </form>
    </nav>

    <section id='main' class="content"><pre class="line-numbers"><span id="1">  1</span>
<span id="2">  2</span>
<span id="3">  3</span>
<span id="4">  4</span>
<span id="5">  5</span>
<span id="6">  6</span>
<span id="7">  7</span>
<span id="8">  8</span>
<span id="9">  9</span>
<span id="10"> 10</span>
<span id="11"> 11</span>
<span id="12"> 12</span>
<span id="13"> 13</span>
<span id="14"> 14</span>
<span id="15"> 15</span>
<span id="16"> 16</span>
<span id="17"> 17</span>
<span id="18"> 18</span>
<span id="19"> 19</span>
<span id="20"> 20</span>
<span id="21"> 21</span>
<span id="22"> 22</span>
<span id="23"> 23</span>
<span id="24"> 24</span>
<span id="25"> 25</span>
<span id="26"> 26</span>
<span id="27"> 27</span>
<span id="28"> 28</span>
<span id="29"> 29</span>
<span id="30"> 30</span>
<span id="31"> 31</span>
<span id="32"> 32</span>
<span id="33"> 33</span>
<span id="34"> 34</span>
<span id="35"> 35</span>
<span id="36"> 36</span>
<span id="37"> 37</span>
<span id="38"> 38</span>
<span id="39"> 39</span>
<span id="40"> 40</span>
<span id="41"> 41</span>
<span id="42"> 42</span>
<span id="43"> 43</span>
<span id="44"> 44</span>
<span id="45"> 45</span>
<span id="46"> 46</span>
<span id="47"> 47</span>
<span id="48"> 48</span>
<span id="49"> 49</span>
<span id="50"> 50</span>
<span id="51"> 51</span>
<span id="52"> 52</span>
<span id="53"> 53</span>
<span id="54"> 54</span>
<span id="55"> 55</span>
<span id="56"> 56</span>
<span id="57"> 57</span>
<span id="58"> 58</span>
<span id="59"> 59</span>
<span id="60"> 60</span>
<span id="61"> 61</span>
<span id="62"> 62</span>
<span id="63"> 63</span>
<span id="64"> 64</span>
<span id="65"> 65</span>
<span id="66"> 66</span>
<span id="67"> 67</span>
<span id="68"> 68</span>
<span id="69"> 69</span>
<span id="70"> 70</span>
<span id="71"> 71</span>
<span id="72"> 72</span>
<span id="73"> 73</span>
<span id="74"> 74</span>
<span id="75"> 75</span>
<span id="76"> 76</span>
<span id="77"> 77</span>
<span id="78"> 78</span>
<span id="79"> 79</span>
<span id="80"> 80</span>
<span id="81"> 81</span>
<span id="82"> 82</span>
<span id="83"> 83</span>
<span id="84"> 84</span>
<span id="85"> 85</span>
<span id="86"> 86</span>
<span id="87"> 87</span>
<span id="88"> 88</span>
<span id="89"> 89</span>
<span id="90"> 90</span>
<span id="91"> 91</span>
<span id="92"> 92</span>
<span id="93"> 93</span>
<span id="94"> 94</span>
<span id="95"> 95</span>
<span id="96"> 96</span>
<span id="97"> 97</span>
<span id="98"> 98</span>
<span id="99"> 99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
</pre><pre class="rust ">
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">collections</span>::<span class="ident">HashMap</span>;

<span class="kw">use</span> <span class="ident">semver</span>::<span class="ident">VersionReq</span>;
<span class="kw">use</span> <span class="ident">url</span>::<span class="ident">Url</span>;

<span class="kw">use</span> <span class="ident">core</span>::{<span class="ident">Source</span>, <span class="ident">SourceId</span>, <span class="ident">SourceMap</span>, <span class="ident">Summary</span>, <span class="ident">Dependency</span>, <span class="ident">PackageId</span>};
<span class="kw">use</span> <span class="ident">core</span>::<span class="ident">PackageSet</span>;
<span class="kw">use</span> <span class="ident">util</span>::{<span class="ident">Config</span>, <span class="ident">profile</span>};
<span class="kw">use</span> <span class="ident">util</span>::<span class="ident">errors</span>::{<span class="ident">CargoResult</span>, <span class="ident">CargoResultExt</span>};
<span class="kw">use</span> <span class="ident">sources</span>::<span class="ident">config</span>::<span class="ident">SourceConfigMap</span>;

<span class="doccomment">/// Source of information about a group of packages.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// See also `core::Source`.</span>
<span class="kw">pub</span> <span class="kw">trait</span> <span class="ident">Registry</span> {
    <span class="doccomment">/// Attempt to find the packages that match a dependency request.</span>
    <span class="kw">fn</span> <span class="ident">query</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>,
             <span class="ident">dep</span>: <span class="kw-2">&amp;</span><span class="ident">Dependency</span>,
             <span class="ident">f</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">FnMut</span>(<span class="ident">Summary</span>)) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span>;

    <span class="kw">fn</span> <span class="ident">query_vec</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">dep</span>: <span class="kw-2">&amp;</span><span class="ident">Dependency</span>) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;&gt;</span> {
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">ret</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">new</span>();
        <span class="self">self</span>.<span class="ident">query</span>(<span class="ident">dep</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="op">|</span><span class="ident">s</span><span class="op">|</span> <span class="ident">ret</span>.<span class="ident">push</span>(<span class="ident">s</span>))<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(<span class="ident">ret</span>)
    }

    <span class="doccomment">/// Returns whether or not this registry will return summaries with</span>
    <span class="doccomment">/// checksums listed.</span>
    <span class="kw">fn</span> <span class="ident">supports_checksums</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="ident">bool</span>;

    <span class="doccomment">/// Returns whether or not this registry will return summaries with</span>
    <span class="doccomment">/// the `precise` field in the source id listed.</span>
    <span class="kw">fn</span> <span class="ident">requires_precise</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="ident">bool</span>;
}

<span class="kw">impl</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span>, <span class="ident">T</span>: <span class="question-mark">?</span><span class="ident">Sized</span> <span class="op">+</span> <span class="ident">Registry</span> <span class="op">+</span> <span class="lifetime">&#39;a</span><span class="op">&gt;</span> <span class="ident">Registry</span> <span class="kw">for</span> <span class="ident">Box</span><span class="op">&lt;</span><span class="ident">T</span><span class="op">&gt;</span> {
    <span class="kw">fn</span> <span class="ident">query</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>,
             <span class="ident">dep</span>: <span class="kw-2">&amp;</span><span class="ident">Dependency</span>,
             <span class="ident">f</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">FnMut</span>(<span class="ident">Summary</span>)) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        (<span class="kw-2">*</span><span class="kw-2">*</span><span class="self">self</span>).<span class="ident">query</span>(<span class="ident">dep</span>, <span class="ident">f</span>)
    }

    <span class="kw">fn</span> <span class="ident">supports_checksums</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="ident">bool</span> {
        (<span class="kw-2">*</span><span class="kw-2">*</span><span class="self">self</span>).<span class="ident">supports_checksums</span>()
    }

    <span class="kw">fn</span> <span class="ident">requires_precise</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="ident">bool</span> {
        (<span class="kw-2">*</span><span class="kw-2">*</span><span class="self">self</span>).<span class="ident">requires_precise</span>()
    }
}

<span class="doccomment">/// This structure represents a registry of known packages. It internally</span>
<span class="doccomment">/// contains a number of `Box&lt;Source&gt;` instances which are used to load a</span>
<span class="doccomment">/// `Package` from.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// The resolution phase of Cargo uses this to drive knowledge about new</span>
<span class="doccomment">/// packages as well as querying for lists of new packages. It is here that</span>
<span class="doccomment">/// sources are updated (e.g. network operations) and overrides are</span>
<span class="doccomment">/// handled.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// The general idea behind this registry is that it is centered around the</span>
<span class="doccomment">/// `SourceMap` structure, contained within which is a mapping of a `SourceId` to</span>
<span class="doccomment">/// a `Source`. Each `Source` in the map has been updated (using network</span>
<span class="doccomment">/// operations if necessary) and is ready to be queried for packages.</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">PackageRegistry</span><span class="op">&lt;</span><span class="lifetime">&#39;cfg</span><span class="op">&gt;</span> {
    <span class="ident">sources</span>: <span class="ident">SourceMap</span><span class="op">&lt;</span><span class="lifetime">&#39;cfg</span><span class="op">&gt;</span>,

    <span class="comment">// A list of sources which are considered &quot;overrides&quot; which take precedent</span>
    <span class="comment">// when querying for packages.</span>
    <span class="ident">overrides</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">SourceId</span><span class="op">&gt;</span>,

    <span class="comment">// Note that each SourceId does not take into account its `precise` field</span>
    <span class="comment">// when hashing or testing for equality. When adding a new `SourceId`, we</span>
    <span class="comment">// want to avoid duplicates in the `SourceMap` (to prevent re-updating the</span>
    <span class="comment">// same git repo twice for example), but we also want to ensure that the</span>
    <span class="comment">// loaded source is always updated.</span>
    <span class="comment">//</span>
    <span class="comment">// Sources with a `precise` field normally don&#39;t need to be updated because</span>
    <span class="comment">// their contents are already on disk, but sources without a `precise` field</span>
    <span class="comment">// almost always need to be updated. If we have a cached `Source` for a</span>
    <span class="comment">// precise `SourceId`, then when we add a new `SourceId` that is not precise</span>
    <span class="comment">// we want to ensure that the underlying source is updated.</span>
    <span class="comment">//</span>
    <span class="comment">// This is basically a long-winded way of saying that we want to know</span>
    <span class="comment">// precisely what the keys of `sources` are, so this is a mapping of key to</span>
    <span class="comment">// what exactly the key is.</span>
    <span class="ident">source_ids</span>: <span class="ident">HashMap</span><span class="op">&lt;</span><span class="ident">SourceId</span>, (<span class="ident">SourceId</span>, <span class="ident">Kind</span>)<span class="op">&gt;</span>,

    <span class="ident">locked</span>: <span class="ident">LockedMap</span>,
    <span class="ident">source_config</span>: <span class="ident">SourceConfigMap</span><span class="op">&lt;</span><span class="lifetime">&#39;cfg</span><span class="op">&gt;</span>,
    <span class="ident">patches</span>: <span class="ident">HashMap</span><span class="op">&lt;</span><span class="ident">Url</span>, <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;&gt;</span>,
}

<span class="kw">type</span> <span class="ident">LockedMap</span> <span class="op">=</span> <span class="ident">HashMap</span><span class="op">&lt;</span><span class="ident">SourceId</span>, <span class="ident">HashMap</span><span class="op">&lt;</span><span class="ident">String</span>, <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">PackageId</span>, <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">PackageId</span><span class="op">&gt;</span>)<span class="op">&gt;&gt;</span><span class="op">&gt;</span>;

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">PartialEq</span>, <span class="ident">Eq</span>, <span class="ident">Clone</span>, <span class="ident">Copy</span>)]</span>
<span class="kw">enum</span> <span class="ident">Kind</span> {
    <span class="ident">Override</span>,
    <span class="ident">Locked</span>,
    <span class="ident">Normal</span>,
}

<span class="kw">impl</span><span class="op">&lt;</span><span class="lifetime">&#39;cfg</span><span class="op">&gt;</span> <span class="ident">PackageRegistry</span><span class="op">&lt;</span><span class="lifetime">&#39;cfg</span><span class="op">&gt;</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">new</span>(<span class="ident">config</span>: <span class="kw-2">&amp;</span><span class="lifetime">&#39;cfg</span> <span class="ident">Config</span>) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span><span class="ident">PackageRegistry</span><span class="op">&lt;</span><span class="lifetime">&#39;cfg</span><span class="op">&gt;&gt;</span> {
        <span class="kw">let</span> <span class="ident">source_config</span> <span class="op">=</span> <span class="ident">SourceConfigMap</span>::<span class="ident">new</span>(<span class="ident">config</span>)<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(<span class="ident">PackageRegistry</span> {
            <span class="ident">sources</span>: <span class="ident">SourceMap</span>::<span class="ident">new</span>(),
            <span class="ident">source_ids</span>: <span class="ident">HashMap</span>::<span class="ident">new</span>(),
            <span class="ident">overrides</span>: <span class="ident">Vec</span>::<span class="ident">new</span>(),
            <span class="ident">source_config</span>: <span class="ident">source_config</span>,
            <span class="ident">locked</span>: <span class="ident">HashMap</span>::<span class="ident">new</span>(),
            <span class="ident">patches</span>: <span class="ident">HashMap</span>::<span class="ident">new</span>(),
        })
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">get</span>(<span class="self">self</span>, <span class="ident">package_ids</span>: <span class="kw-2">&amp;</span>[<span class="ident">PackageId</span>]) <span class="op">-&gt;</span> <span class="ident">PackageSet</span><span class="op">&lt;</span><span class="lifetime">&#39;cfg</span><span class="op">&gt;</span> {
        <span class="macro">trace</span><span class="macro">!</span>(<span class="string">&quot;getting packages; sources={}&quot;</span>, <span class="self">self</span>.<span class="ident">sources</span>.<span class="ident">len</span>());
        <span class="ident">PackageSet</span>::<span class="ident">new</span>(<span class="ident">package_ids</span>, <span class="self">self</span>.<span class="ident">sources</span>)
    }

    <span class="kw">fn</span> <span class="ident">ensure_loaded</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">namespace</span>: <span class="kw-2">&amp;</span><span class="ident">SourceId</span>, <span class="ident">kind</span>: <span class="ident">Kind</span>) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="self">self</span>.<span class="ident">source_ids</span>.<span class="ident">get</span>(<span class="ident">namespace</span>) {
            <span class="comment">// We&#39;ve previously loaded this source, and we&#39;ve already locked it,</span>
            <span class="comment">// so we&#39;re not allowed to change it even if `namespace` has a</span>
            <span class="comment">// slightly different precise version listed.</span>
            <span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span>(_, <span class="ident">Kind</span>::<span class="ident">Locked</span>)) <span class="op">=&gt;</span> {
                <span class="macro">debug</span><span class="macro">!</span>(<span class="string">&quot;load/locked   {}&quot;</span>, <span class="ident">namespace</span>);
                <span class="kw">return</span> <span class="prelude-val">Ok</span>(())
            }

            <span class="comment">// If the previous source was not a precise source, then we can be</span>
            <span class="comment">// sure that it&#39;s already been updated if we&#39;ve already loaded it.</span>
            <span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span>(<span class="kw-2">ref</span> <span class="ident">previous</span>, _)) <span class="kw">if</span> <span class="ident">previous</span>.<span class="ident">precise</span>().<span class="ident">is_none</span>() <span class="op">=&gt;</span> {
                <span class="macro">debug</span><span class="macro">!</span>(<span class="string">&quot;load/precise  {}&quot;</span>, <span class="ident">namespace</span>);
                <span class="kw">return</span> <span class="prelude-val">Ok</span>(())
            }

            <span class="comment">// If the previous source has the same precise version as we do,</span>
            <span class="comment">// then we&#39;re done, otherwise we need to need to move forward</span>
            <span class="comment">// updating this source.</span>
            <span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span>(<span class="kw-2">ref</span> <span class="ident">previous</span>, _)) <span class="op">=&gt;</span> {
                <span class="kw">if</span> <span class="ident">previous</span>.<span class="ident">precise</span>() <span class="op">==</span> <span class="ident">namespace</span>.<span class="ident">precise</span>() {
                    <span class="macro">debug</span><span class="macro">!</span>(<span class="string">&quot;load/match    {}&quot;</span>, <span class="ident">namespace</span>);
                    <span class="kw">return</span> <span class="prelude-val">Ok</span>(())
                }
                <span class="macro">debug</span><span class="macro">!</span>(<span class="string">&quot;load/mismatch {}&quot;</span>, <span class="ident">namespace</span>);
            }
            <span class="prelude-val">None</span> <span class="op">=&gt;</span> {
                <span class="macro">debug</span><span class="macro">!</span>(<span class="string">&quot;load/missing  {}&quot;</span>, <span class="ident">namespace</span>);
            }
        }

        <span class="self">self</span>.<span class="ident">load</span>(<span class="ident">namespace</span>, <span class="ident">kind</span>)<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">add_sources</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">ids</span>: <span class="kw-2">&amp;</span>[<span class="ident">SourceId</span>]) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="kw">for</span> <span class="ident">id</span> <span class="kw">in</span> <span class="ident">ids</span>.<span class="ident">iter</span>() {
            <span class="self">self</span>.<span class="ident">ensure_loaded</span>(<span class="ident">id</span>, <span class="ident">Kind</span>::<span class="ident">Locked</span>)<span class="question-mark">?</span>;
        }
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">add_preloaded</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">source</span>: <span class="ident">Box</span><span class="op">&lt;</span><span class="ident">Source</span> <span class="op">+</span> <span class="lifetime">&#39;cfg</span><span class="op">&gt;</span>) {
        <span class="self">self</span>.<span class="ident">add_source</span>(<span class="ident">source</span>, <span class="ident">Kind</span>::<span class="ident">Locked</span>);
    }

    <span class="kw">fn</span> <span class="ident">add_source</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">source</span>: <span class="ident">Box</span><span class="op">&lt;</span><span class="ident">Source</span> <span class="op">+</span> <span class="lifetime">&#39;cfg</span><span class="op">&gt;</span>, <span class="ident">kind</span>: <span class="ident">Kind</span>) {
        <span class="kw">let</span> <span class="ident">id</span> <span class="op">=</span> <span class="ident">source</span>.<span class="ident">source_id</span>().<span class="ident">clone</span>();
        <span class="self">self</span>.<span class="ident">sources</span>.<span class="ident">insert</span>(<span class="ident">source</span>);
        <span class="self">self</span>.<span class="ident">source_ids</span>.<span class="ident">insert</span>(<span class="ident">id</span>.<span class="ident">clone</span>(), (<span class="ident">id</span>, <span class="ident">kind</span>));
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">add_override</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">source</span>: <span class="ident">Box</span><span class="op">&lt;</span><span class="ident">Source</span> <span class="op">+</span> <span class="lifetime">&#39;cfg</span><span class="op">&gt;</span>) {
        <span class="self">self</span>.<span class="ident">overrides</span>.<span class="ident">push</span>(<span class="ident">source</span>.<span class="ident">source_id</span>().<span class="ident">clone</span>());
        <span class="self">self</span>.<span class="ident">add_source</span>(<span class="ident">source</span>, <span class="ident">Kind</span>::<span class="ident">Override</span>);
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">register_lock</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">id</span>: <span class="ident">PackageId</span>, <span class="ident">deps</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">PackageId</span><span class="op">&gt;</span>) {
        <span class="macro">trace</span><span class="macro">!</span>(<span class="string">&quot;register_lock: {}&quot;</span>, <span class="ident">id</span>);
        <span class="kw">for</span> <span class="ident">dep</span> <span class="kw">in</span> <span class="ident">deps</span>.<span class="ident">iter</span>() {
            <span class="macro">trace</span><span class="macro">!</span>(<span class="string">&quot;\t-&gt; {}&quot;</span>, <span class="ident">dep</span>);
        }
        <span class="kw">let</span> <span class="ident">sub_map</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">locked</span>.<span class="ident">entry</span>(<span class="ident">id</span>.<span class="ident">source_id</span>().<span class="ident">clone</span>())
                                 .<span class="ident">or_insert</span>(<span class="ident">HashMap</span>::<span class="ident">new</span>());
        <span class="kw">let</span> <span class="ident">sub_vec</span> <span class="op">=</span> <span class="ident">sub_map</span>.<span class="ident">entry</span>(<span class="ident">id</span>.<span class="ident">name</span>().<span class="ident">to_string</span>())
                             .<span class="ident">or_insert</span>(<span class="ident">Vec</span>::<span class="ident">new</span>());
        <span class="ident">sub_vec</span>.<span class="ident">push</span>((<span class="ident">id</span>, <span class="ident">deps</span>));
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">patch</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">url</span>: <span class="kw-2">&amp;</span><span class="ident">Url</span>, <span class="ident">deps</span>: <span class="kw-2">&amp;</span>[<span class="ident">Dependency</span>]) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">deps</span> <span class="op">=</span> <span class="ident">deps</span>.<span class="ident">iter</span>().<span class="ident">map</span>(<span class="op">|</span><span class="ident">dep</span><span class="op">|</span> {
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">summaries</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">query_vec</span>(<span class="ident">dep</span>)<span class="question-mark">?</span>.<span class="ident">into_iter</span>();
            <span class="kw">let</span> <span class="ident">summary</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">summaries</span>.<span class="ident">next</span>() {
                <span class="prelude-val">Some</span>(<span class="ident">summary</span>) <span class="op">=&gt;</span> <span class="ident">summary</span>,
                <span class="prelude-val">None</span> <span class="op">=&gt;</span> {
                    <span class="macro">bail</span><span class="macro">!</span>(<span class="string">&quot;patch for `{}` in `{}` did not resolve to any crates. If this is \
                           unexpected, you may wish to consult: \
                           https://github.com/rust-lang/cargo/issues/4678&quot;</span>,
                          <span class="ident">dep</span>.<span class="ident">name</span>(), <span class="ident">url</span>)
                }
            };
            <span class="kw">if</span> <span class="ident">summaries</span>.<span class="ident">next</span>().<span class="ident">is_some</span>() {
                <span class="macro">bail</span><span class="macro">!</span>(<span class="string">&quot;patch for `{}` in `{}` resolved to more than one candidate&quot;</span>,
                      <span class="ident">dep</span>.<span class="ident">name</span>(), <span class="ident">url</span>)
            }
            <span class="kw">if</span> <span class="ident">summary</span>.<span class="ident">package_id</span>().<span class="ident">source_id</span>().<span class="ident">url</span>() <span class="op">==</span> <span class="ident">url</span> {
                <span class="macro">bail</span><span class="macro">!</span>(<span class="string">&quot;patch for `{}` in `{}` points to the same source, but \
                       patches must point to different sources&quot;</span>,
                      <span class="ident">dep</span>.<span class="ident">name</span>(), <span class="ident">url</span>);
            }
            <span class="prelude-val">Ok</span>(<span class="ident">summary</span>)
        }).<span class="ident">collect</span>::<span class="op">&lt;</span><span class="ident">CargoResult</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;&gt;</span><span class="op">&gt;</span>().<span class="ident">chain_err</span>(<span class="op">||</span> {
            <span class="macro">format_err</span><span class="macro">!</span>(<span class="string">&quot;failed to resolve patches for `{}`&quot;</span>, <span class="ident">url</span>)
        })<span class="question-mark">?</span>;

        <span class="self">self</span>.<span class="ident">patches</span>.<span class="ident">insert</span>(<span class="ident">url</span>.<span class="ident">clone</span>(), <span class="ident">deps</span>);

        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">patches</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="kw-2">&amp;</span><span class="ident">HashMap</span><span class="op">&lt;</span><span class="ident">Url</span>, <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;&gt;</span> {
        <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">patches</span>
    }

    <span class="kw">fn</span> <span class="ident">load</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">source_id</span>: <span class="kw-2">&amp;</span><span class="ident">SourceId</span>, <span class="ident">kind</span>: <span class="ident">Kind</span>) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        (<span class="op">||</span> {
            <span class="kw">let</span> <span class="ident">source</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">source_config</span>.<span class="ident">load</span>(<span class="ident">source_id</span>)<span class="question-mark">?</span>;
            <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">source</span>.<span class="ident">source_id</span>(), <span class="ident">source_id</span>);

            <span class="kw">if</span> <span class="ident">kind</span> <span class="op">==</span> <span class="ident">Kind</span>::<span class="ident">Override</span> {
                <span class="self">self</span>.<span class="ident">overrides</span>.<span class="ident">push</span>(<span class="ident">source_id</span>.<span class="ident">clone</span>());
            }
            <span class="self">self</span>.<span class="ident">add_source</span>(<span class="ident">source</span>, <span class="ident">kind</span>);

            <span class="comment">// Ensure the source has fetched all necessary remote data.</span>
            <span class="kw">let</span> <span class="ident">_p</span> <span class="op">=</span> <span class="ident">profile</span>::<span class="ident">start</span>(<span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;updating: {}&quot;</span>, <span class="ident">source_id</span>));
            <span class="self">self</span>.<span class="ident">sources</span>.<span class="ident">get_mut</span>(<span class="ident">source_id</span>).<span class="ident">unwrap</span>().<span class="ident">update</span>()
        })().<span class="ident">chain_err</span>(<span class="op">||</span> <span class="macro">format_err</span><span class="macro">!</span>(<span class="string">&quot;Unable to update {}&quot;</span>, <span class="ident">source_id</span>))<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">fn</span> <span class="ident">query_overrides</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">dep</span>: <span class="kw-2">&amp;</span><span class="ident">Dependency</span>)
                       <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span><span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;&gt;</span> {
        <span class="kw">for</span> <span class="ident">s</span> <span class="kw">in</span> <span class="self">self</span>.<span class="ident">overrides</span>.<span class="ident">iter</span>() {
            <span class="kw">let</span> <span class="ident">src</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">sources</span>.<span class="ident">get_mut</span>(<span class="ident">s</span>).<span class="ident">unwrap</span>();
            <span class="kw">let</span> <span class="ident">dep</span> <span class="op">=</span> <span class="ident">Dependency</span>::<span class="ident">new_override</span>(<span class="ident">dep</span>.<span class="ident">name</span>(), <span class="ident">s</span>);
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">results</span> <span class="op">=</span> <span class="ident">src</span>.<span class="ident">query_vec</span>(<span class="kw-2">&amp;</span><span class="ident">dep</span>)<span class="question-mark">?</span>;
            <span class="kw">if</span> <span class="op">!</span><span class="ident">results</span>.<span class="ident">is_empty</span>() {
                <span class="kw">return</span> <span class="prelude-val">Ok</span>(<span class="prelude-val">Some</span>(<span class="ident">results</span>.<span class="ident">remove</span>(<span class="number">0</span>)))
            }
        }
        <span class="prelude-val">Ok</span>(<span class="prelude-val">None</span>)
    }

    <span class="doccomment">/// This function is used to transform a summary to another locked summary</span>
    <span class="doccomment">/// if possible. This is where the concept of a lockfile comes into play.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// If a summary points at a package id which was previously locked, then we</span>
    <span class="doccomment">/// override the summary&#39;s id itself, as well as all dependencies, to be</span>
    <span class="doccomment">/// rewritten to the locked versions. This will transform the summary&#39;s</span>
    <span class="doccomment">/// source to a precise source (listed in the locked version) as well as</span>
    <span class="doccomment">/// transforming all of the dependencies from range requirements on</span>
    <span class="doccomment">/// imprecise sources to exact requirements on precise sources.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// If a summary does not point at a package id which was previously locked,</span>
    <span class="doccomment">/// or if any dependencies were added and don&#39;t have a previously listed</span>
    <span class="doccomment">/// version, we still want to avoid updating as many dependencies as</span>
    <span class="doccomment">/// possible to keep the graph stable. In this case we map all of the</span>
    <span class="doccomment">/// summary&#39;s dependencies to be rewritten to a locked version wherever</span>
    <span class="doccomment">/// possible. If we&#39;re unable to map a dependency though, we just pass it on</span>
    <span class="doccomment">/// through.</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">lock</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">summary</span>: <span class="ident">Summary</span>) <span class="op">-&gt;</span> <span class="ident">Summary</span> {
        <span class="ident">lock</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">locked</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">patches</span>, <span class="ident">summary</span>)
    }

    <span class="kw">fn</span> <span class="ident">warn_bad_override</span>(<span class="kw-2">&amp;</span><span class="self">self</span>,
                         <span class="ident">override_summary</span>: <span class="kw-2">&amp;</span><span class="ident">Summary</span>,
                         <span class="ident">real_summary</span>: <span class="kw-2">&amp;</span><span class="ident">Summary</span>) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">real_deps</span> <span class="op">=</span> <span class="ident">real_summary</span>.<span class="ident">dependencies</span>().<span class="ident">iter</span>().<span class="ident">collect</span>::<span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;&gt;</span>();

        <span class="kw">let</span> <span class="ident">boilerplate</span> <span class="op">=</span> <span class="string">&quot;\
This is currently allowed but is known to produce buggy behavior with spurious
recompiles and changes to the crate graph. Path overrides unfortunately were
never intended to support this feature, so for now this message is just a
warning. In the future, however, this message will become a hard error.

To change the dependency graph via an override it&#39;s recommended to use the
`[replace]` feature of Cargo instead of the path override feature. This is
documented online at the url below for more information.

http://doc.crates.io/specifying-dependencies.html#overriding-dependencies
&quot;</span>;

        <span class="kw">for</span> <span class="ident">dep</span> <span class="kw">in</span> <span class="ident">override_summary</span>.<span class="ident">dependencies</span>() {
            <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">i</span>) <span class="op">=</span> <span class="ident">real_deps</span>.<span class="ident">iter</span>().<span class="ident">position</span>(<span class="op">|</span><span class="ident">d</span><span class="op">|</span> <span class="ident">dep</span> <span class="op">==</span> <span class="kw-2">*</span><span class="ident">d</span>) {
                <span class="ident">real_deps</span>.<span class="ident">remove</span>(<span class="ident">i</span>);
                <span class="kw">continue</span>
            }
            <span class="kw">let</span> <span class="ident">msg</span> <span class="op">=</span> <span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;\
                path override for crate `{}` has altered the original list of\n\
                dependencies; the dependency on `{}` was either added or\n\
                modified to not match the previously resolved version\n\n\
                {}&quot;</span>, <span class="ident">override_summary</span>.<span class="ident">package_id</span>().<span class="ident">name</span>(), <span class="ident">dep</span>.<span class="ident">name</span>(), <span class="ident">boilerplate</span>);
            <span class="self">self</span>.<span class="ident">source_config</span>.<span class="ident">config</span>().<span class="ident">shell</span>().<span class="ident">warn</span>(<span class="kw-2">&amp;</span><span class="ident">msg</span>)<span class="question-mark">?</span>;
            <span class="kw">return</span> <span class="prelude-val">Ok</span>(())
        }

        <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">id</span>) <span class="op">=</span> <span class="ident">real_deps</span>.<span class="ident">get</span>(<span class="number">0</span>) {
            <span class="kw">let</span> <span class="ident">msg</span> <span class="op">=</span> <span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;\
                path override for crate `{}` has altered the original list of
                dependencies; the dependency on `{}` was removed\n\n
                {}&quot;</span>, <span class="ident">override_summary</span>.<span class="ident">package_id</span>().<span class="ident">name</span>(), <span class="ident">id</span>.<span class="ident">name</span>(), <span class="ident">boilerplate</span>);
            <span class="self">self</span>.<span class="ident">source_config</span>.<span class="ident">config</span>().<span class="ident">shell</span>().<span class="ident">warn</span>(<span class="kw-2">&amp;</span><span class="ident">msg</span>)<span class="question-mark">?</span>;
            <span class="kw">return</span> <span class="prelude-val">Ok</span>(())
        }

        <span class="prelude-val">Ok</span>(())
    }
}

<span class="kw">impl</span><span class="op">&lt;</span><span class="lifetime">&#39;cfg</span><span class="op">&gt;</span> <span class="ident">Registry</span> <span class="kw">for</span> <span class="ident">PackageRegistry</span><span class="op">&lt;</span><span class="lifetime">&#39;cfg</span><span class="op">&gt;</span> {
    <span class="kw">fn</span> <span class="ident">query</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>,
             <span class="ident">dep</span>: <span class="kw-2">&amp;</span><span class="ident">Dependency</span>,
             <span class="ident">f</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">FnMut</span>(<span class="ident">Summary</span>)) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="kw">let</span> (<span class="ident">override_summary</span>, <span class="ident">n</span>, <span class="ident">to_warn</span>) <span class="op">=</span> {
            <span class="comment">// Look for an override and get ready to query the real source.</span>
            <span class="kw">let</span> <span class="ident">override_summary</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">query_overrides</span>(<span class="ident">dep</span>)<span class="question-mark">?</span>;

            <span class="comment">// Next up on our list of candidates is to check the `[patch]`</span>
            <span class="comment">// section of the manifest. Here we look through all patches</span>
            <span class="comment">// relevant to the source that `dep` points to, and then we match</span>
            <span class="comment">// name/version. Note that we don&#39;t use `dep.matches(..)` because</span>
            <span class="comment">// the patches, by definition, come from a different source.</span>
            <span class="comment">// This means that `dep.matches(..)` will always return false, when</span>
            <span class="comment">// what we really care about is the name/version match.</span>
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">patches</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;</span>::<span class="ident">new</span>();
            <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">extra</span>) <span class="op">=</span> <span class="self">self</span>.<span class="ident">patches</span>.<span class="ident">get</span>(<span class="ident">dep</span>.<span class="ident">source_id</span>().<span class="ident">url</span>()) {
                <span class="ident">patches</span>.<span class="ident">extend</span>(<span class="ident">extra</span>.<span class="ident">iter</span>().<span class="ident">filter</span>(<span class="op">|</span><span class="ident">s</span><span class="op">|</span> {
                    <span class="ident">dep</span>.<span class="ident">matches_ignoring_source</span>(<span class="ident">s</span>)
                }).<span class="ident">cloned</span>());
            }

            <span class="comment">// A crucial feature of the `[patch]` feature is that we *don&#39;t*</span>
            <span class="comment">// query the actual registry if we have a &quot;locked&quot; dependency. A</span>
            <span class="comment">// locked dep basically just means a version constraint of `=a.b.c`,</span>
            <span class="comment">// and because patches take priority over the actual source then if</span>
            <span class="comment">// we have a candidate we&#39;re done.</span>
            <span class="kw">if</span> <span class="ident">patches</span>.<span class="ident">len</span>() <span class="op">==</span> <span class="number">1</span> <span class="op">&amp;&amp;</span> <span class="ident">dep</span>.<span class="ident">is_locked</span>() {
                <span class="kw">let</span> <span class="ident">patch</span> <span class="op">=</span> <span class="ident">patches</span>.<span class="ident">remove</span>(<span class="number">0</span>);
                <span class="kw">match</span> <span class="ident">override_summary</span> {
                    <span class="prelude-val">Some</span>(<span class="ident">summary</span>) <span class="op">=&gt;</span> (<span class="ident">summary</span>, <span class="number">1</span>, <span class="prelude-val">Some</span>(<span class="ident">patch</span>)),
                    <span class="prelude-val">None</span> <span class="op">=&gt;</span> {
                        <span class="ident">f</span>(<span class="ident">patch</span>);
                        <span class="kw">return</span> <span class="prelude-val">Ok</span>(())
                    }
                }
            } <span class="kw">else</span> {
                <span class="kw">if</span> <span class="op">!</span><span class="ident">patches</span>.<span class="ident">is_empty</span>() {
                    <span class="macro">debug</span><span class="macro">!</span>(<span class="string">&quot;found {} patches with an unlocked dep, \
                            looking at sources&quot;</span>, <span class="ident">patches</span>.<span class="ident">len</span>());
                }

                <span class="comment">// Ensure the requested source_id is loaded</span>
                <span class="self">self</span>.<span class="ident">ensure_loaded</span>(<span class="ident">dep</span>.<span class="ident">source_id</span>(), <span class="ident">Kind</span>::<span class="ident">Normal</span>).<span class="ident">chain_err</span>(<span class="op">||</span> {
                    <span class="macro">format_err</span><span class="macro">!</span>(<span class="string">&quot;failed to load source for a dependency \
                                 on `{}`&quot;</span>, <span class="ident">dep</span>.<span class="ident">name</span>())
                })<span class="question-mark">?</span>;

                <span class="kw">let</span> <span class="ident">source</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">sources</span>.<span class="ident">get_mut</span>(<span class="ident">dep</span>.<span class="ident">source_id</span>());
                <span class="kw">match</span> (<span class="ident">override_summary</span>, <span class="ident">source</span>) {
                    (<span class="prelude-val">Some</span>(_), <span class="prelude-val">None</span>) <span class="op">=&gt;</span> <span class="macro">bail</span><span class="macro">!</span>(<span class="string">&quot;override found but no real ones&quot;</span>),
                    (<span class="prelude-val">None</span>, <span class="prelude-val">None</span>) <span class="op">=&gt;</span> <span class="kw">return</span> <span class="prelude-val">Ok</span>(()),

                    <span class="comment">// If we don&#39;t have an override then we just ship</span>
                    <span class="comment">// everything upstairs after locking the summary</span>
                    (<span class="prelude-val">None</span>, <span class="prelude-val">Some</span>(<span class="ident">source</span>)) <span class="op">=&gt;</span> {
                        <span class="kw">for</span> <span class="ident">patch</span> <span class="kw">in</span> <span class="ident">patches</span>.<span class="ident">iter</span>() {
                            <span class="ident">f</span>(<span class="ident">patch</span>.<span class="ident">clone</span>());
                        }

                        <span class="comment">// Our sources shouldn&#39;t ever come back to us with two</span>
                        <span class="comment">// summaries that have the same version. We could,</span>
                        <span class="comment">// however, have an `[patch]` section which is in use</span>
                        <span class="comment">// to override a version in the registry. This means</span>
                        <span class="comment">// that if our `summary` in this loop has the same</span>
                        <span class="comment">// version as something in `patches` that we&#39;ve</span>
                        <span class="comment">// already selected, then we skip this `summary`.</span>
                        <span class="kw">let</span> <span class="ident">locked</span> <span class="op">=</span> <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">locked</span>;
                        <span class="kw">let</span> <span class="ident">all_patches</span> <span class="op">=</span> <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">patches</span>;
                        <span class="kw">return</span> <span class="ident">source</span>.<span class="ident">query</span>(<span class="ident">dep</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="op">|</span><span class="ident">summary</span><span class="op">|</span> {
                            <span class="kw">for</span> <span class="ident">patch</span> <span class="kw">in</span> <span class="ident">patches</span>.<span class="ident">iter</span>() {
                                <span class="kw">let</span> <span class="ident">patch</span> <span class="op">=</span> <span class="ident">patch</span>.<span class="ident">package_id</span>().<span class="ident">version</span>();
                                <span class="kw">if</span> <span class="ident">summary</span>.<span class="ident">package_id</span>().<span class="ident">version</span>() <span class="op">==</span> <span class="ident">patch</span> {
                                    <span class="kw">return</span>
                                }
                            }
                            <span class="ident">f</span>(<span class="ident">lock</span>(<span class="ident">locked</span>, <span class="ident">all_patches</span>, <span class="ident">summary</span>))
                        })
                    }

                    <span class="comment">// If we have an override summary then we query the source</span>
                    <span class="comment">// to sanity check its results. We don&#39;t actually use any of</span>
                    <span class="comment">// the summaries it gives us though.</span>
                    (<span class="prelude-val">Some</span>(<span class="ident">override_summary</span>), <span class="prelude-val">Some</span>(<span class="ident">source</span>)) <span class="op">=&gt;</span> {
                        <span class="kw">if</span> <span class="op">!</span><span class="ident">patches</span>.<span class="ident">is_empty</span>() {
                            <span class="macro">bail</span><span class="macro">!</span>(<span class="string">&quot;found patches and a path override&quot;</span>)
                        }
                        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">n</span> <span class="op">=</span> <span class="number">0</span>;
                        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">to_warn</span> <span class="op">=</span> <span class="prelude-val">None</span>;
                        <span class="ident">source</span>.<span class="ident">query</span>(<span class="ident">dep</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="op">|</span><span class="ident">summary</span><span class="op">|</span> {
                            <span class="ident">n</span> <span class="op">+=</span> <span class="number">1</span>;
                            <span class="ident">to_warn</span> <span class="op">=</span> <span class="prelude-val">Some</span>(<span class="ident">summary</span>);
                        })<span class="question-mark">?</span>;
                        (<span class="ident">override_summary</span>, <span class="ident">n</span>, <span class="ident">to_warn</span>)
                    }
                }
            }
        };

        <span class="kw">if</span> <span class="ident">n</span> <span class="op">&gt;</span> <span class="number">1</span> {
            <span class="macro">bail</span><span class="macro">!</span>(<span class="string">&quot;found an override with a non-locked list&quot;</span>);
        } <span class="kw">else</span> <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">summary</span>) <span class="op">=</span> <span class="ident">to_warn</span> {
            <span class="self">self</span>.<span class="ident">warn_bad_override</span>(<span class="kw-2">&amp;</span><span class="ident">override_summary</span>, <span class="kw-2">&amp;</span><span class="ident">summary</span>)<span class="question-mark">?</span>;
        }
        <span class="ident">f</span>(<span class="self">self</span>.<span class="ident">lock</span>(<span class="ident">override_summary</span>));
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">fn</span> <span class="ident">supports_checksums</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="ident">bool</span> {
        <span class="bool-val">false</span>
    }

    <span class="kw">fn</span> <span class="ident">requires_precise</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="ident">bool</span> {
        <span class="bool-val">false</span>
    }
}

<span class="kw">fn</span> <span class="ident">lock</span>(<span class="ident">locked</span>: <span class="kw-2">&amp;</span><span class="ident">LockedMap</span>,
        <span class="ident">patches</span>: <span class="kw-2">&amp;</span><span class="ident">HashMap</span><span class="op">&lt;</span><span class="ident">Url</span>, <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;&gt;</span>,
        <span class="ident">summary</span>: <span class="ident">Summary</span>) <span class="op">-&gt;</span> <span class="ident">Summary</span> {
    <span class="kw">let</span> <span class="ident">pair</span> <span class="op">=</span> <span class="ident">locked</span>.<span class="ident">get</span>(<span class="ident">summary</span>.<span class="ident">source_id</span>()).<span class="ident">and_then</span>(<span class="op">|</span><span class="ident">map</span><span class="op">|</span> {
        <span class="ident">map</span>.<span class="ident">get</span>(<span class="ident">summary</span>.<span class="ident">name</span>())
    }).<span class="ident">and_then</span>(<span class="op">|</span><span class="ident">vec</span><span class="op">|</span> {
        <span class="ident">vec</span>.<span class="ident">iter</span>().<span class="ident">find</span>(<span class="op">|</span><span class="op">&amp;&amp;</span>(<span class="kw-2">ref</span> <span class="ident">id</span>, _)<span class="op">|</span> <span class="ident">id</span> <span class="op">==</span> <span class="ident">summary</span>.<span class="ident">package_id</span>())
    });

    <span class="macro">trace</span><span class="macro">!</span>(<span class="string">&quot;locking summary of {}&quot;</span>, <span class="ident">summary</span>.<span class="ident">package_id</span>());

    <span class="comment">// Lock the summary&#39;s id if possible</span>
    <span class="kw">let</span> <span class="ident">summary</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">pair</span> {
        <span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span>(<span class="kw-2">ref</span> <span class="ident">precise</span>, _)) <span class="op">=&gt;</span> <span class="ident">summary</span>.<span class="ident">override_id</span>(<span class="ident">precise</span>.<span class="ident">clone</span>()),
        <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="ident">summary</span>,
    };
    <span class="ident">summary</span>.<span class="ident">map_dependencies</span>(<span class="op">|</span><span class="ident">dep</span><span class="op">|</span> {
        <span class="macro">trace</span><span class="macro">!</span>(<span class="string">&quot;\t{}/{}/{}&quot;</span>, <span class="ident">dep</span>.<span class="ident">name</span>(), <span class="ident">dep</span>.<span class="ident">version_req</span>(),
               <span class="ident">dep</span>.<span class="ident">source_id</span>());

        <span class="comment">// If we&#39;ve got a known set of overrides for this summary, then</span>
        <span class="comment">// one of a few cases can arise:</span>
        <span class="comment">//</span>
        <span class="comment">// 1. We have a lock entry for this dependency from the same</span>
        <span class="comment">//    source as it&#39;s listed as coming from. In this case we make</span>
        <span class="comment">//    sure to lock to precisely the given package id.</span>
        <span class="comment">//</span>
        <span class="comment">// 2. We have a lock entry for this dependency, but it&#39;s from a</span>
        <span class="comment">//    different source than what&#39;s listed, or the version</span>
        <span class="comment">//    requirement has changed. In this case we must discard the</span>
        <span class="comment">//    locked version because the dependency needs to be</span>
        <span class="comment">//    re-resolved.</span>
        <span class="comment">//</span>
        <span class="comment">// 3. We don&#39;t have a lock entry for this dependency, in which</span>
        <span class="comment">//    case it was likely an optional dependency which wasn&#39;t</span>
        <span class="comment">//    included previously so we just pass it through anyway.</span>
        <span class="comment">//</span>
        <span class="comment">// Cases 1/2 are handled by `matches_id` and case 3 is handled by</span>
        <span class="comment">// falling through to the logic below.</span>
        <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span>(_, <span class="kw-2">ref</span> <span class="ident">locked_deps</span>)) <span class="op">=</span> <span class="ident">pair</span> {
            <span class="kw">let</span> <span class="ident">locked</span> <span class="op">=</span> <span class="ident">locked_deps</span>.<span class="ident">iter</span>().<span class="ident">find</span>(<span class="op">|</span><span class="ident">id</span><span class="op">|</span> <span class="ident">dep</span>.<span class="ident">matches_id</span>(<span class="ident">id</span>));
            <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">locked</span>) <span class="op">=</span> <span class="ident">locked</span> {
                <span class="macro">trace</span><span class="macro">!</span>(<span class="string">&quot;\tfirst hit on {}&quot;</span>, <span class="ident">locked</span>);
                <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">dep</span> <span class="op">=</span> <span class="ident">dep</span>.<span class="ident">clone</span>();
                <span class="ident">dep</span>.<span class="ident">lock_to</span>(<span class="ident">locked</span>);
                <span class="kw">return</span> <span class="ident">dep</span>
            }
        }

        <span class="comment">// If this dependency did not have a locked version, then we query</span>
        <span class="comment">// all known locked packages to see if they match this dependency.</span>
        <span class="comment">// If anything does then we lock it to that and move on.</span>
        <span class="kw">let</span> <span class="ident">v</span> <span class="op">=</span> <span class="ident">locked</span>.<span class="ident">get</span>(<span class="ident">dep</span>.<span class="ident">source_id</span>()).<span class="ident">and_then</span>(<span class="op">|</span><span class="ident">map</span><span class="op">|</span> {
            <span class="ident">map</span>.<span class="ident">get</span>(<span class="ident">dep</span>.<span class="ident">name</span>())
        }).<span class="ident">and_then</span>(<span class="op">|</span><span class="ident">vec</span><span class="op">|</span> {
            <span class="ident">vec</span>.<span class="ident">iter</span>().<span class="ident">find</span>(<span class="op">|</span><span class="op">&amp;&amp;</span>(<span class="kw-2">ref</span> <span class="ident">id</span>, _)<span class="op">|</span> <span class="ident">dep</span>.<span class="ident">matches_id</span>(<span class="ident">id</span>))
        });
        <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span>(<span class="kw-2">ref</span> <span class="ident">id</span>, _)) <span class="op">=</span> <span class="ident">v</span> {
            <span class="macro">trace</span><span class="macro">!</span>(<span class="string">&quot;\tsecond hit on {}&quot;</span>, <span class="ident">id</span>);
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">dep</span> <span class="op">=</span> <span class="ident">dep</span>.<span class="ident">clone</span>();
            <span class="ident">dep</span>.<span class="ident">lock_to</span>(<span class="ident">id</span>);
            <span class="kw">return</span> <span class="ident">dep</span>
        }

        <span class="comment">// Finally we check to see if any registered patches correspond to</span>
        <span class="comment">// this dependency.</span>
        <span class="kw">let</span> <span class="ident">v</span> <span class="op">=</span> <span class="ident">patches</span>.<span class="ident">get</span>(<span class="ident">dep</span>.<span class="ident">source_id</span>().<span class="ident">url</span>()).<span class="ident">map</span>(<span class="op">|</span><span class="ident">vec</span><span class="op">|</span> {
            <span class="kw">let</span> <span class="ident">dep2</span> <span class="op">=</span> <span class="ident">dep</span>.<span class="ident">clone</span>();
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">iter</span> <span class="op">=</span> <span class="ident">vec</span>.<span class="ident">iter</span>().<span class="ident">filter</span>(<span class="kw">move</span> <span class="op">|</span><span class="ident">s</span><span class="op">|</span> {
                <span class="ident">dep2</span>.<span class="ident">name</span>() <span class="op">==</span> <span class="ident">s</span>.<span class="ident">package_id</span>().<span class="ident">name</span>() <span class="op">&amp;&amp;</span>
                    <span class="ident">dep2</span>.<span class="ident">version_req</span>().<span class="ident">matches</span>(<span class="ident">s</span>.<span class="ident">package_id</span>().<span class="ident">version</span>())
            });
            (<span class="ident">iter</span>.<span class="ident">next</span>(), <span class="ident">iter</span>)
        });
        <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>((<span class="prelude-val">Some</span>(<span class="ident">summary</span>), <span class="kw-2">mut</span> <span class="ident">remaining</span>)) <span class="op">=</span> <span class="ident">v</span> {
            <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">remaining</span>.<span class="ident">next</span>().<span class="ident">is_none</span>());
            <span class="kw">let</span> <span class="ident">patch_source</span> <span class="op">=</span> <span class="ident">summary</span>.<span class="ident">package_id</span>().<span class="ident">source_id</span>();
            <span class="kw">let</span> <span class="ident">patch_locked</span> <span class="op">=</span> <span class="ident">locked</span>.<span class="ident">get</span>(<span class="ident">patch_source</span>).<span class="ident">and_then</span>(<span class="op">|</span><span class="ident">m</span><span class="op">|</span> {
                <span class="ident">m</span>.<span class="ident">get</span>(<span class="ident">summary</span>.<span class="ident">package_id</span>().<span class="ident">name</span>())
            }).<span class="ident">map</span>(<span class="op">|</span><span class="ident">list</span><span class="op">|</span> {
                <span class="ident">list</span>.<span class="ident">iter</span>().<span class="ident">any</span>(<span class="op">|</span><span class="kw-2">&amp;</span>(<span class="kw-2">ref</span> <span class="ident">id</span>, _)<span class="op">|</span> <span class="ident">id</span> <span class="op">==</span> <span class="ident">summary</span>.<span class="ident">package_id</span>())
            }).<span class="ident">unwrap_or</span>(<span class="bool-val">false</span>);

            <span class="kw">if</span> <span class="ident">patch_locked</span> {
                <span class="macro">trace</span><span class="macro">!</span>(<span class="string">&quot;\tthird hit on {}&quot;</span>, <span class="ident">summary</span>.<span class="ident">package_id</span>());
                <span class="kw">let</span> <span class="ident">req</span> <span class="op">=</span> <span class="ident">VersionReq</span>::<span class="ident">exact</span>(<span class="ident">summary</span>.<span class="ident">package_id</span>().<span class="ident">version</span>());
                <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">dep</span> <span class="op">=</span> <span class="ident">dep</span>.<span class="ident">clone</span>();
                <span class="ident">dep</span>.<span class="ident">set_version_req</span>(<span class="ident">req</span>);
                <span class="kw">return</span> <span class="ident">dep</span>
            }
        }

        <span class="macro">trace</span><span class="macro">!</span>(<span class="string">&quot;\tnope, unlocked&quot;</span>);
        <span class="ident">dep</span>
    })
}

<span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">test</span>)]</span>
<span class="kw">pub</span> <span class="kw">mod</span> <span class="ident">test</span> {
    <span class="kw">use</span> <span class="ident">core</span>::{<span class="ident">Summary</span>, <span class="ident">Registry</span>, <span class="ident">Dependency</span>};
    <span class="kw">use</span> <span class="ident">util</span>::<span class="ident">CargoResult</span>;

    <span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">RegistryBuilder</span> {
        <span class="ident">summaries</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;</span>,
        <span class="ident">overrides</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;</span>
    }

    <span class="kw">impl</span> <span class="ident">RegistryBuilder</span> {
        <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">new</span>() <span class="op">-&gt;</span> <span class="ident">RegistryBuilder</span> {
            <span class="ident">RegistryBuilder</span> { <span class="ident">summaries</span>: <span class="macro">vec</span><span class="macro">!</span>[], <span class="ident">overrides</span>: <span class="macro">vec</span><span class="macro">!</span>[] }
        }

        <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">summary</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">summary</span>: <span class="ident">Summary</span>) <span class="op">-&gt;</span> <span class="ident">RegistryBuilder</span> {
            <span class="self">self</span>.<span class="ident">summaries</span>.<span class="ident">push</span>(<span class="ident">summary</span>);
            <span class="self">self</span>
        }

        <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">summaries</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">summaries</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="ident">RegistryBuilder</span> {
            <span class="self">self</span>.<span class="ident">summaries</span>.<span class="ident">extend</span>(<span class="ident">summaries</span>.<span class="ident">into_iter</span>());
            <span class="self">self</span>
        }

        <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">add_override</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">summary</span>: <span class="ident">Summary</span>) <span class="op">-&gt;</span> <span class="ident">RegistryBuilder</span> {
            <span class="self">self</span>.<span class="ident">overrides</span>.<span class="ident">push</span>(<span class="ident">summary</span>);
            <span class="self">self</span>
        }

        <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">overrides</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">summaries</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="ident">RegistryBuilder</span> {
            <span class="self">self</span>.<span class="ident">overrides</span>.<span class="ident">extend</span>(<span class="ident">summaries</span>.<span class="ident">into_iter</span>());
            <span class="self">self</span>
        }

        <span class="kw">fn</span> <span class="ident">query_overrides</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">dep</span>: <span class="kw-2">&amp;</span><span class="ident">Dependency</span>) <span class="op">-&gt;</span> <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Summary</span><span class="op">&gt;</span> {
            <span class="self">self</span>.<span class="ident">overrides</span>.<span class="ident">iter</span>()
                .<span class="ident">filter</span>(<span class="op">|</span><span class="ident">s</span><span class="op">|</span> <span class="ident">s</span>.<span class="ident">name</span>() <span class="op">==</span> <span class="ident">dep</span>.<span class="ident">name</span>())
                .<span class="ident">map</span>(<span class="op">|</span><span class="ident">s</span><span class="op">|</span> <span class="ident">s</span>.<span class="ident">clone</span>())
                .<span class="ident">collect</span>()
        }
    }

    <span class="kw">impl</span> <span class="ident">Registry</span> <span class="kw">for</span> <span class="ident">RegistryBuilder</span> {
        <span class="kw">fn</span> <span class="ident">query</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>,
                 <span class="ident">dep</span>: <span class="kw-2">&amp;</span><span class="ident">Dependency</span>,
                 <span class="ident">f</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">FnMut</span>(<span class="ident">Summary</span>)) <span class="op">-&gt;</span> <span class="ident">CargoResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
            <span class="macro">debug</span><span class="macro">!</span>(<span class="string">&quot;querying; dep={:?}&quot;</span>, <span class="ident">dep</span>);

            <span class="kw">let</span> <span class="ident">overrides</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">query_overrides</span>(<span class="ident">dep</span>);

            <span class="kw">if</span> <span class="ident">overrides</span>.<span class="ident">is_empty</span>() {
                <span class="kw">for</span> <span class="ident">s</span> <span class="kw">in</span> <span class="self">self</span>.<span class="ident">summaries</span>.<span class="ident">iter</span>() {
                    <span class="kw">if</span> <span class="ident">dep</span>.<span class="ident">matches</span>(<span class="ident">s</span>) {
                        <span class="ident">f</span>(<span class="ident">s</span>.<span class="ident">clone</span>());
                    }
                }
                <span class="prelude-val">Ok</span>(())
            } <span class="kw">else</span> {
                <span class="kw">for</span> <span class="ident">s</span> <span class="kw">in</span> <span class="ident">overrides</span> {
                    <span class="ident">f</span>(<span class="ident">s</span>);
                }
                <span class="prelude-val">Ok</span>(())
            }
        }

        <span class="kw">fn</span> <span class="ident">supports_checksums</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="ident">bool</span> {
            <span class="bool-val">false</span>
        }

        <span class="kw">fn</span> <span class="ident">requires_precise</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-&gt;</span> <span class="ident">bool</span> {
            <span class="bool-val">false</span>
        }
    }
}
</pre>
</section>
    <section id='search' class="content hidden"></section>

    <section class="footer"></section>

    <aside id="help" class="hidden">
        <div>
            <h1 class="hidden">Help</h1>

            <div class="shortcuts">
                <h2>Keyboard Shortcuts</h2>

                <dl>
                    <dt>?</dt>
                    <dd>Show this help dialog</dd>
                    <dt>S</dt>
                    <dd>Focus the search field</dd>
                    <dt>↑</dt>
                    <dd>Move up in search results</dd>
                    <dt>↓</dt>
                    <dd>Move down in search results</dd>
                    <dt>↹</dt>
                    <dd>Switch tab</dd>
                    <dt>&#9166;</dt>
                    <dd>Go to active search result</dd>
                    <dt style="width:31px;">+ / -</dt>
                    <dd>Collapse/expand all sections</dd>
                </dl>
            </div>

            <div class="infos">
                <h2>Search Tricks</h2>

                <p>
                    Prefix searches with a type followed by a colon (e.g.
                    <code>fn:</code>) to restrict the search to a given type.
                </p>

                <p>
                    Accepted types are: <code>fn</code>, <code>mod</code>,
                    <code>struct</code>, <code>enum</code>,
                    <code>trait</code>, <code>type</code>, <code>macro</code>,
                    and <code>const</code>.
                </p>

                <p>
                    Search functions by type signature (e.g.
                    <code>vec -> usize</code> or <code>* -> vec</code>)
                </p>
            </div>
        </div>
    </aside>

    

    <script>
        window.rootPath = "../../../";
        window.currentCrate = "cargo";
    </script>
    <script src="../../../main.js"></script>
    <script defer src="../../../search-index.js"></script>
</body>
</html>